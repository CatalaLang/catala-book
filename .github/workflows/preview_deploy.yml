name: PR Preview Deployment

on:
  workflow_run:
    workflows: ["PR Preview Build"]
    types:
      - completed

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      pull-requests: write
      actions: read
    env:
      CF_WORKERS_SUBDOMAIN: catala-book-preview

    steps:
      - name: Download build artifact from workflow run
        uses: actions/download-artifact@v4
        with:
          name: mdbook-site
          path: ./book/site
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Add robots.txt to prevent indexing
        run: |
          echo "User-agent: *" > ./book/site/robots.txt
          echo "Disallow: /" >> ./book/site/robots.txt

      - name: Add noindex headers
        run: |
          echo "/*" > ./book/site/_headers
          echo "  X-Robots-Tag: noindex, nofollow" >> ./book/site/_headers

      - name: Download PR metadata
        uses: actions/download-artifact@v4
        with:
          name: pr-metadata
          path: ./pr-metadata
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Read PR number
        id: pr
        run: |
          PR_NUMBER=$(cat ./pr-metadata/pr-number.txt)
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Create wrangler config for static assets
        run: |
          cat > wrangler.jsonc <<'JSON'
          {
            "name": "catala-book-preview-pr-${{ steps.pr.outputs.number }}",
            "compatibility_date": "2025-04-01",
            "workers_dev": true,
            "preview_urls": true,
            "assets": { "directory": "./book/site" }
          }
          JSON

      - name: Deploy Worker (get deployment URL)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: 4.21.0
          command: deploy --config wrangler.jsonc

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.deploy.outputs.deployment-url }}
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.number }}');
            const deploymentUrl = process.env.PREVIEW_URL;
            
            const comment = `## Preview Deployment Ready
            
            Your changes have been deployed to a preview environment:
            
            **Preview URL:** ${deploymentUrl}
            
            > Note: This preview is not indexed by search engines (robots.txt and X-Robots-Tag configured)
            
            This preview will be updated automatically with each new commit to this PR.`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment Ready')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
