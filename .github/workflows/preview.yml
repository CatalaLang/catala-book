name: PR Preview Deployment

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  build:
    uses: ./.github/workflows/build.yml

  deploy-preview:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      pull-requests: write
    env:
      CF_WORKERS_SUBDOMAIN: catala-book-preview
    
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mdbook-site
          path: ./book/site

      - name: Add robots.txt to prevent indexing
        run: |
          echo "User-agent: *" > ./book/site/robots.txt
          echo "Disallow: /" >> ./book/site/robots.txt

      - name: Add noindex headers
        run: |
          echo "/*" > ./book/site/_headers
          echo "  X-Robots-Tag: noindex, nofollow" >> ./book/site/_headers

      - name: Create wrangler config for static assets
        run: |
          cat > wrangler.jsonc <<'JSON'
          {
            "name": "catala-book-preview",
            "compatibility_date": "2025-04-01",
            "workers_dev": true,
            "preview_urls": true,
            "assets": { "directory": "./book/site" }
          }
          JSON

      - name: Deploy Worker (get deployment URL)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: 4.21.0
          command: deploy --config wrangler.jsonc

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.deploy.outputs.deployment-url }}
        with:
          script: |
            const prNumber = context.issue.number;
            const deploymentUrl = process.env.PREVIEW_URL;
            
            const comment = `## Preview Deployment Ready
            
            Your changes have been deployed to a preview environment:
            
            **Preview URL:** ${deploymentUrl}
            
            > Note: This preview is not indexed by search engines (robots.txt and X-Robots-Tag configured)
            
            This preview will be updated automatically with each new commit to this PR.`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment Ready')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
